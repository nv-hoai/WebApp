@model FastFood.MVC.Models.Order
@using System.Globalization
@{
    ViewBag.Title = "Chi tiết đơn hàng";
    var vi = CultureInfo.GetCultureInfo("vi-VN");
}

<h3 class="mt-3 mb-3">Chi tiết đơn hàng #@Model.OrderID của khách hàng #@Model.CustomerID</h3>

<div class="mb-4">
    <p><strong>Địa chỉ giao hàng:</strong> @Model.Address</p>
    <p><strong>Ngày đặt:</strong> @Model.CreatedAt.ToString("dd/MM/yyyy HH:mm")</p>
    <p>
        <strong>Trạng thái:</strong>
        @switch (Model.Status)
        {
            case OrderStatus.Pending:
                @:<span class="badge bg-secondary">Mới tạo</span>
                break;
            case OrderStatus.Processing:
                @:<span class="badge bg-warning text-dark">Đang xử lý</span>
                break;
            case OrderStatus.Delivering:
                @:<span class="badge bg-info text-dark">Đang giao</span>
                break;
            case OrderStatus.Completed:
                @:<span class="badge bg-success">Hoàn tất</span>
                break;
            case OrderStatus.Cancelled:
                @:<span class="badge bg-danger">Đã hủy</span>
                break;
        }
    </p>
</div>

<table class="table table-bordered table-hover">
    <thead>
        <tr>
            <th scope="col">Hình ảnh</th>
            <th scope="col">Tên sản phẩm</th>
            <th scope="col">Số lượng</th>
            <th scope="col">Giá gốc</th>
            <th scope="col">Giá sau giảm</th>
            <th scope="col">Thành tiền</th>
        </tr>
    </thead>
    <tbody id="cartItems">
        @if (TempData["CartError"] != null)
        {
            <tr>
                <td colspan="5">
                    <div class="alert alert-danger" role="alert">
                        @TempData["CartError"]
                    </div>
                </td>
            </tr>
        }
        @foreach (var item in Model.OrderDetails)
        {
            <tr data-product-id="@item.ProductID">
                <td>
                    @if (item.Product != null)
                    {
                        <img src="@item.Product.ImageUrl" alt="Ảnh sản phẩm" width="60" />
                    }
                    else
                    {
                        <span class="text-danger">Không có ảnh</span>
                    }
                </td>
                <td>@item.ProductName</td>
                <td class="text-center">
                    <button type="button" class="btn-decrease btn btn-link btn-lg" style="color:red" data-productid="@item.ProductID">-</button>
                    <span class="item-quantity">@item.Quantity</span>
                    <button type="button" class="btn-increase btn btn-link btn-lg" data-productid="@item.ProductID">+</button>
                </td>
                <td class="text-decoration-line-through text-muted me-2 text-center">
                    @((item.UnitPrice * 1000).ToString("#,##0", System.Globalization.CultureInfo.GetCultureInfo("vi-VN"))) VND
                </td>
                <td class="fw-bold text-danger text-center">
                    @((item.DiscountedUnitPrice * 1000).ToString("#,##0", System.Globalization.CultureInfo.GetCultureInfo("vi-VN"))) VND
                </td>
                <td class="item-subtotal text-center">
                    @((item.SubTotal * 1000).ToString("#,##0", System.Globalization.CultureInfo.GetCultureInfo("vi-VN"))) VND
                </td>
            </tr>
        }
    </tbody>
</table>

<div class="text-end">
    <p><strong>Tạm tính:</strong> 
        @((Model.SubTotal * 1000).ToString("#,##0", System.Globalization.CultureInfo.GetCultureInfo("vi-VN"))) VND
    </p>
    <p><strong>Phí giao hàng:</strong> 
        @((Model.ShippingFee * 1000).ToString("#,##0", System.Globalization.CultureInfo.GetCultureInfo("vi-VN"))) VND
    </p>
    <p><strong>Tổng thanh toán:</strong> 
        <span class="text-danger fw-bold">
            @((Model.TotalCharge *1000)?.ToString("#,##0", System.Globalization.CultureInfo.GetCultureInfo("vi-VN"))) VND
        </span>
    </p>
    <button class="btn btn-danger btn-sm rounded mt-2 btn-delete"
            data-orderid="@Model.OrderID">
        <i class="fa fa-times me-1"></i> Hủy đơn
    </button>
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const buttons = document.querySelectorAll(".btn-delete");

            buttons.forEach(btn => {
                btn.addEventListener("click", function () {
                    const orderID = this.getAttribute("data-orderid");

                    if (confirm(`Bạn có chắc muốn hủy đơn hàng #${orderID}?`)) {
                        fetch(`/Order/Cancel?orderID=${orderID}`, {
                            method: "POST",
                            headers: {
                                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value ?? ''
                            }
                        })
                        .then(res => res.json())
                        .then(data => {
                            alert(data.message);
                            if (data.success) {
                                location.reload(); 
                            }
                        })
                        .catch(err => {
                            console.error("Lỗi khi hủy đơn hàng:", err);
                            alert("Đã có lỗi xảy ra!");
                        });
                    }
                });
            });
        });
    </script>
}
